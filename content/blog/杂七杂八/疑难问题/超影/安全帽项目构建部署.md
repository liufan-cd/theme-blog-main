### jenkins打包
- jenkins拉取代码[编译](#maven-install)生成xjar
- 执行[build.sh](#build.sh)
- 执行[deploy.sh](#deploy.sh)
- 推送docker仓库

### 脚本文件分析
<span id = 'maven-install'>

#### maven加密jar
```bash
$MAVEN_HOME/bin/mvn -Dmaven.test.skip=true -Dxjar.password='cat /dev/urandm | head -n 32 | md5sum | head -c 32' clean install
cd target
go build xjar.jar
```
通过上述命令生成xjar文件和启动器通过`xjar java -jar *xjar.jar`启动
</span>
<span id='build.sh'>

#### build.sh
##### 依赖
- [set-env.sh](#global-set-env.sh)
- [set-env.sh](#set-env.sh)
- [docker-entrypoint.sh](#docker-entrypoint.sh)
- [Dokerfile](#Dokerfile)
##### 作用
- 调用设置环境变量的脚本，引入全局变量和项目变量
- 构建jar包启动命令并输出到[docker-entrypoint.sh](#docker-entrypoint.sh)中
- 使用[Dokerfile](#Dokerfile)构建镜像
```bash
#!/bin/bash
BASE_PATH=$(cd `dirname $0`; pwd)
source ../../set-env.sh
source $BASE_PATH/../bin/set-env.sh

JAVA_OPTS="-Xloggc:/logs/gc.log -verbose:gc -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/logs"
JAVA_OPTS="$JAVA_OPTS -Dspring.config.location=conf/$CONFIG_FILE"
JAVA_OPTS="$JAVA_OPTS -Dspring.profiles.active=pro"
JAVA_OPTS="$JAVA_OPTS -Djava.awt.headless=true -Duser.timezone=GMT+8"
JAVA_OPTS="$JAVA_OPTS -Djava.security.egd=file:/dev/./urandom"

# 追加启动脚本命令
echo "JAVA_OPTS=\"\$JAVA_OPTS $JAVA_OPTS\"" >> docker-entrypoint.sh
echo "JAVA_CMD=\"java \$JAVA_OPTS -jar $APP_XJAR_JAR\"" >> docker-entrypoint.sh
echo "JAVA_CMD=\"./xjar \$JAVA_CMD\"" >> docker-entrypoint.sh
echo "echo \$JAVA_CMD >> command.log" >> docker-entrypoint.sh
echo \$JAVA_CMD >> docker-entrypoint.sh
# 追加docker启动命令
# 使用java -jar命令启动应用,以便关闭容器时能回调服务关闭钩子,执行命令占位符,命令在构建时根据配置动态替换
#if [ `tail -1 Dockerfile | grep ENTRYPOINT | wc -l` == 0 ]; then
#    echo "ENTRYPOINT $JAVA_CMD" >> Dockerfile
#fi
# 替换windows系统换行符
sed -i 's/
//g' Dockerfile
# 复制压缩包到当前目录
cp $BASE_PATH/../../$APP_NAME.tar.gz .
cp $BASE_PATH/../fonts/simhei.ttf .
# build
docker build -t cy/hm_$APP_NAME:$APP_VERSION .

```
</span>

<span id = 'global-set-env.sh'>

#### 全局环境变量设置
```bash
#!/bin/bash

export PERSIST_VOLUME=/home/test/volume

export LOOP_HOST=127.0.0.1
export LOCALHOST_HOST=192.168.10.239
export PUBLIC_HOST=$LOCALHOST_HOST
export REAL_PUBLIC_HOST=192.168.10.239

export NACOS_HOST=$LOCALHOST_HOST
export NACOS_PORT=18090

export SENTINEL_HOST=$LOCALHOST_HOST
export SENTINEL_PORT=18110
export SENTINEL_CLIENT_HOST=$REAL_PUBLIC_HOST

export ZIPKIN_HOST=$LOCALHOST_HOST
export ZIPKIN_PORT=18100

export KAFKA_HOST=hm-kafka
export KAFKA_PORT=9092

export RABBITMQ_HOST=hm-rabbitmq
export RABBITMQ_PORT=5672
export RABBITMQ_USERNAME=cy-crypto\(iRCrdfJTuRIpwkXtQGAckA==\)
export RABBITMQ_PASSWORD=cy-crypto\(xAFyGqaNR+nSbocWgIrvKg==\)

export MYSQL_HOST=hm-mysql
export MYSQL_PORT=3306
export MYSQL_USERNAME=cy-crypto\(5aR19x0xiC+Dj/Bdf+6QmA==\)
export MYSQL_PASSWORD=cy-crypto\(Zsjve0+YBPCLqYks02sZQQ==\)

export REDIS_HOST=hm-redis
export REDIS_PORT=6379

export ZOOKEEPER_HOST=hm-zookeeper
export ZOOKEEPER_CLIENT_PORT=2181
export ZOOKEEPER_ELECTION_PORT=2888
export ZOOKEEPER_LEADER_PORT=3888

export MONGODB_HOST=hm-mongo
export MONGODB_PORT=27017

export SRS_HOST=121.11.107.98
export SRS_PORT=1935
export SRS_API_PORT=1985
export SRS_HTTP_FLV_PORT=19642

export POSTE_HOST=hm-poste
export POSTE_SMTP_PORT=465

export FILE_UPLOAD_HOST=$REAL_PUBLIC_HOST
export FILE_UPLOAD_PORT=19550

export MQTT_HOST_URL=tcp://hm-emqx:1883
export MQTT_USERNAME=cy-crypto\(iRCrdfJTuRIpwkXtQGAckA==\)
export MQTT_PASSWORD=cy-crypto\(xAFyGqaNR+nSbocWgIrvKg==\)
export MQTT_TOPICS=logout

#export MQTT_HOST_URL_HIGH=tcp://hm-emqx:1883
export MQTT_HOST_URL_HIGH=tcp://121.11.107.98:18070
export MQTT_USERNAME_HIGH=cy-crypto\(iRCrdfJTuRIpwkXtQGAckA==\)
export MQTT_PASSWORD_HIGH=cy-crypto\(xAFyGqaNR+nSbocWgIrvKg==\)

export WS_HOST=$REAL_PUBLIC_HOST
export WS_PORT=18901
export WSS_HOST=$REAL_PUBLIC_HOST
export WSS_PORT=18902

export EDGE_NAME=239
```
</sapn>
<sapn id = 'set-env.sh'>

#### 单一模块的环境变量设置
```bash
#!/bin/bash
# 版本
APP_VERSION=v2.0.1-master
APP_NAME=user-server
#-------------Java运行jar---------------------
#运行的jar
APP_JAR=user-server.jar
APP_XJAR_JAR=$APP_NAME-xjar.jar
CONFIG_FILE=application-pro.properties
APP_PORT=8080

#-------------远程调试--------------------------------
#：关闭调试的方式：注释掉行ENABLE_DEBUG=debug
#ENABLE_DEBUG=debug
# 先找已有环境变量,如果环境变量为空,则设置环境变量;方便修改yml中配置,重启docker即可开启
if [ ! $ENABLE_DEBUG ]; then
  ENABLE_DEBUG=
fi
#远程调试端口
DEBUG_PORT=8078
#-------------jmx监控--------------------------------
#是否开启jmx监控
#ENABLE_JMX=rmi
if [ ! $ENABLE_JMX ]; then
  ENABLE_JMX=
fi
#监控端口
if [ ! $JMX_PORT ]; then
  JMX_PORT=19564
fi
#本地地址
if [ ! $JMX_HOSTNAME ]; then
  JMX_HOSTNAME=$PUBLIC_HOST
fi
#-------------内存设置--------------------------------
MIN_MEM=128m
if [ ! $MAX_MEM ]; then
  MAX_MEM=1024m

```
</span>
<span id = 'Dokerfile'>

#### 构建镜像依据的Dokerfile
### notice
- 挂载[docker-entrypoint.sh](#docker-entrypoint.sh)启动脚本
- ADD ./user-server.tar.gz /home/ 会自动解压user-server.tar.gz，该压缩包是maven编译生成后的xjar包及其启动xjar文件

```
BOOT
│  user-server-xjar.jar
│  user-server.jar
│  xjar
├─bin
├─***
└─logs
```

```bash
# Dokerfile
FROM 125.124.125.183:18500/cy/hm-jdk:8u231-alpine-glibc

# lang
ENV LANG=C.UTF-8
ENV APP_HOME=/home/user-server/

RUN apk add --update ttf-dejavu fontconfig && rm -rf /var/cache/apk/*

ADD ./user-server.tar.gz /home/

ADD ./docker-entrypoint.sh ${APP_HOME}/entrypoint.sh

EXPOSE 8080

VOLUME ${APP_HOME}
VOLUME /logs

WORKDIR ${APP_HOME}

ENTRYPOINT ["./entrypoint.sh"]
```
<span>
<span id = 'docker-entrypoint.sh'>

#### 镜像启动entrypoint执行的命令（此处entrypoint即为项目jar）
```bash
# entrypoint.sh

#!/bin/sh
JAVA_OPTS="-server -Xms$MIN_MEM -Xmx$MAX_MEM"

if [ "$ENABLE_DEBUG" = "debug" ]; then
    JAVA_OPTS="$JAVA_OPTS -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,address=8078,server=y,suspend=n"
fi
if [ "$ENABLE_JMX" = "rmi" ]; then
    JAVA_OPTS="$JAVA_OPTS -Djava.rmi.server.hostname=$JMX_HOSTNAME -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=$JMX_PORT -Dcom.sun.management.jmxremote.rmi.port=$JMX_PORT -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.local.only=false"
fi
JAVA_OPTS="$JAVA_OPTS -Xloggc:/logs/gc.log -verbose:gc -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/logs -Dspring.config.location=conf/application-pro.properties -Dspring.profiles.active=pro -Djava.awt.headless=true -Duser.timezone=GMT+8 -Djava.security.egd=file:/dev/./urandom"
JAVA_CMD="java $JAVA_OPTS -jar user-server-xjar.jar"
JAVA_CMD="./xjar $JAVA_CMD"
echo $JAVA_CMD >> command.log
$JAVA_CMD
```
</span>
<span id = 'deploy.sh'>

#### 启动容器命令
```bash
# deploy.sh
#!/bin/bash
BASE_PATH=$(cd `dirname $0`; pwd)
cd $BASE_PATH
source ../../set-env.sh

docker-compose -f compose-deploy.yml down -v
docker-compose -f compose-deploy.yml up --no-start
docker-compose -f compose-deploy.yml start

# docker volume ls -qf dangling=true | xargs -r docker volume rm {} &>/dev/null
# docker images|grep none|awk '{print "docker rmi "$3}'|sh &>/dev/null

```
</span>
<span id = 'compose-deploy.yml'>

#### 启动容器的相关配置

##### network
ip由于不同容器之间加载顺序是动态的，所以不建议直接写死ip。同一项目的不同docker容器需要加入到同一网络中，可以使用doker容器名称作为域名访问该网络下的其他容器，例如nginx镜像中的配置文件[default-http.conf](#nginx)
```bash
# compose-deploy.yml
version: '3'
services:
  userserver:
    container_name:  'user'
    image: "cy/hm_user-server:v2.0.1-master"
    restart: always
    ports:
      - "19580:8080"
      - "19581:8078"
      - "19583:19583"
    volumes:
      - $PERSIST_VOLUME/userserver/logs:/logs
      - $PERSIST_VOLUME/userserver/data:/data
      - /etc/localtime:/etc/localtime:ro
      - /usr/share/zoneinfo/Asia/Shanghai:/usr/share/zoneinfo/Asia/Shanghai:ro
    environment:
      - ENABLE_DEBUG=debug
      - MIN_MEM=128m
      - MAX_MEM=1024m
      - ENABLE_JMX=
      - NACOS_HOST=$NACOS_HOST
      - NACOS_PORT=$NACOS_PORT
      - SENTINEL_HOST=$SENTINEL_HOST
      - SENTINEL_PORT=$SENTINEL_PORT
      - ZIPKIN_HOST=$ZIPKIN_HOST
      - ZIPKIN_PORT=$ZIPKIN_PORT
      - REDIS_HOST=$REDIS_HOST
      - REDIS_PORT=$REDIS_PORT
      - RABBITMQ_HOST=$RABBITMQ_HOST
      - RABBITMQ_PORT=$RABBITMQ_PORT
      - RABBITMQ_USERNAME=$RABBITMQ_USERNAME
      - RABBITMQ_PASSWORD=$RABBITMQ_PASSWORD
      - MYSQL_HOST=$MYSQL_HOST
      - MYSQL_PORT=$MYSQL_PORT
      - MYSQL_USERNAME=$MYSQL_USERNAME
      - MYSQL_PASSWORD=$MYSQL_PASSWORD
      - PUBLIC_HOST=$PUBLIC_HOST
      - POSTE_HOST=$POSTE_HOST
      - POSTE_SMTP_PORT=$POSTE_SMTP_PORT
      - SENTINEL_CLIENT_HOST=$SENTINEL_CLIENT_HOST
      - WS_HOST=$WS_HOST
      - WS_PORT=$WS_PORT
      - WSS_HOST=$WSS_HOST
      - WSS_PORT=$WSS_PORT
networks:
  default:
    external:
      name: docker_default
```
</span>

<sapn id = 'nginx'>

```
client_max_body_size 100m;
send_timeout 1800;
proxy_read_timeout 1800;   

upstream ms-server {
    server gatewayserver:8080;
}
upstream srs-server {
    server srsserver:8080;
}
upstream ms-iui {
    server iui:8080;
}
upstream ms-nacos {
    server nacos:8848;
}
#upstream ms-arthas {
#    server arthas:8080;
#}

server {
    listen 80;
    listen 443 ssl;

    server_tokens off;

    ssl_certificate /etc/nginx/server.crt;
    ssl_certificate_key /etc/nginx/server.key;

    if ($request_method !~* GET|POST) {
            return 403;
    }

    fastcgi_intercept_errors on;
    error_page 404 500 502 503 504 /error.html;
    location = /error.html {
        root /usr/share/nginx/html;
    }

    sendfile        on;
#    location /WebReport {
#		proxy_set_header X-Forwarded-For localhost;
#		proxy_pass  http://ms-report; break;  
#	}
    location  / {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST';
        add_header Access-Control-Expose-Headers 'Server,range,Content-Length,Content-Range';
#        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
#        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,If-Modified-Since,Authorization,origin,range,accept-encoding,referer,Cache-Control,X-Proxy-Authorization,X-Requested-With,Content-Type';
        add_header Access-Control-Allow-Headers 'origin,range,accept-encoding,referer,Cache-Control,X-Proxy-Authorization,X-Requested-With,Content-Type';
#        add_header X-Frame-Options SAMEORIGIN;

        #rewrite ^/api/(.*)$  /$1 last;   
        # ����
        if ($uri ~* ^/(version|userServer|roleServer|helmetServer|fenceServer|fileServer|locationServer|reportServer|planServer)/) { 
            proxy_pass     http://ms-server; break;  
        }
#        if ($uri ~* ^/(live)/) { 
#            proxy_pass     http://srs-server; break;  
#        }
       
        proxy_pass     http://ms-iui; break;           

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $remote_addr;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /live {
        proxy_pass     http://srs-server; break;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $remote_addr;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    location /nacos {
        proxy_pass     http://ms-nacos; break;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $remote_addr;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
#    location /arthas {
#        proxy_pass     http://ms-arthas; break;
#    }
}

```
</span>